<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"
    />
    <title>COEX RAG Assistant</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="title">COEX ì´ë²¤íŠ¸ ì•ˆë‚´</div>
      <div id="status" class="status">ì—°ê²° í™•ì¸ ì¤‘â€¦</div>
    </header>

    <div class="main-layout">
      <section class="prompt-editor">
        <aside class="sidebar">
          <h3>System Prompt</h3>
          <textarea
            id="system-prompt"
            rows="10"
            cols="100"
            style="width: 100%"
            placeholder="System Promptë¥¼ ì…ë ¥í•˜ì„¸ìš”"
          ></textarea>
          <button id="go-btn" style="width: 100%; margin-top: 5px">go</button>
        </aside>
      </section>

      <div id="token-info" class="token-info"></div>

      <main class="chat-area">
        <div id="chat" class="chat"></div>
        <form id="composer" class="composer" autocomplete="off">
          <input id="q" class="input" type="text" inputmode="search" />
          <button class="send" aria-label="ë³´ë‚´ê¸°">ë³´ë‚´ê¸°</button>
        </form>
      </main>

      <template id="bubble">
        <div class="bubble">
          <div class="bubble-inner"></div>
        </div>
      </template>
    </div>

    <!-- <script src="/socket.io/socket.io.js"></script> -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      // ê¸°ë³¸ ë°±ì—”ë“œ URL (Render/Railway ê°™ì€ ê³ ì • ì£¼ì†Œê°€ ìˆìœ¼ë©´ ì—¬ê¸° ë„£ê¸°)
      // const DEFAULT_API = "https://4a3ca69675bb.ngrok-free.app"; // ì„ì‹œ: ngrok ì£¼ì†Œ or ê³ ì • ë°±ì—”ë“œ ì£¼ì†Œ
      const DEFAULT_API = "https://49a3df4cfe17.ngrok-free.app"; // ì„ì‹œ: ngrok ì£¼ì†Œ or ê³ ì • ë°±ì—”ë“œ ì£¼ì†Œ

      // í¸ì˜ê¸°ëŠ¥: ?api= ë¡œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥ + localStorage ì €ì¥
      const urlApi = new URLSearchParams(location.search).get("api");
      const lsApi = localStorage.getItem("API_BASE");
      const API = urlApi || lsApi || DEFAULT_API;
      if (urlApi) localStorage.setItem("API_BASE", urlApi);

      console.log("[client] API =", API);

      // WebSocket ì—°ê²°
      const socket = io(API, {
        path: "/socket.io",
        transports: ["websocket"],
      });

      socket.on("connect", () => {
        const statusEl = document.getElementById("status");
        statusEl.textContent = "ì—°ê²°ë¨";
        statusEl.classList.remove("bad");
        statusEl.classList.add("ok");
        console.log("[socket] connected:", socket.id);
      });
      socket.on("disconnect", () => {
        const statusEl = document.getElementById("status");
        statusEl.textContent = "ì—°ê²° ëŠê¹€";
        statusEl.classList.remove("ok");
        statusEl.classList.add("bad");
        console.log("[socket] disconnected");
      });

      // (ì„ íƒ) í—¬ìŠ¤ì²´í¬ ë¡œê·¸ë¡œ ë°±ì—”ë“œ í†µì‹  í™•ì¸
      fetch(`${API}/health`)
        .then((r) => r.json())
        .then((j) => console.log("[health]", j))
        .catch((err) => console.warn("[health error]", err));
      // ë§Œì•½ fetchë¥¼ ì“°ëŠ” ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì´ë ‡ê²Œ:
      // fetch(`${API}/health`)
      // fetch(`${API}/query_with_embedding`, { ... })
    </script>

    <script>
      function addTokenLine(afterNode, tokens) {
        const div = document.createElement("div");
        div.className = "token-line";
        const { input = 0, output = 0, total = input + output } = tokens || {};
        div.textContent = `ğŸ“Š í† í° ì‚¬ìš©ëŸ‰: ì…ë ¥ ${input.toLocaleString()} / ì¶œë ¥ ${output.toLocaleString()} / ì´ ${total.toLocaleString()}`;
        // ë§í’ì„  ë°”ë¡œ ë’¤ì— ê½‚ê¸°
        afterNode.insertAdjacentElement("afterend", div);
        div.scrollIntoView({ behavior: "smooth", block: "end" });
      }

      function addBotTurn(answerText, tokens, hits) {
        // â‘  í„´ ë˜í¼
        const turn = document.createElement("div");
        turn.className = "turn";
        chat.appendChild(turn);

        // â‘¡ ë´‡ ë§í’ì„ 
        const node = bubbleTpl.content.firstElementChild.cloneNode(true);
        node.classList.add("bot");
        node.querySelector(".bubble-inner").textContent =
          answerText || "(ì‘ë‹µ ì—†ìŒ)";
        turn.appendChild(node);

        // â‘¢ í† í° ë¼ì¸(ìˆìœ¼ë©´)
        if (tokens) {
          const div = document.createElement("div");
          div.className = "token-line";
          const { input = 0, output = 0, total } = tokens || {};
          const totalSafe = Number.isFinite(total) ? total : input + output;
          div.textContent =
            `ğŸ“Š í† í° ì‚¬ìš©ëŸ‰: ì…ë ¥ ${input.toLocaleString()} / ` +
            `ì¶œë ¥ ${output.toLocaleString()} / ì´ ${totalSafe.toLocaleString()}`;
          turn.appendChild(div);
        }

        // â‘£ íˆì¸ (ìˆìœ¼ë©´) - ê°™ì€ í„´ ì•ˆì— ë¶™ì—¬ì£¼ë©´ íë¦„ì´ ìì—°ìŠ¤ëŸ¬ì›€
        if (hits && hits.length) {
          const lines = hits.map(
            (h, i) =>
              `[${i + 1}] ${h?.meta?.title || ""} | ${h?.meta?.date || ""} | ${
                h?.meta?.venue || ""
              }`
          );
          const details = document.createElement("details");
          details.className = "hits";
          const sum = document.createElement("summary");
          sum.textContent = `ì°¸ì¡°í•œ ì´ë²¤íŠ¸ (${hits.length})`;
          const pre = document.createElement("pre");
          pre.textContent = lines.join("\n");
          details.appendChild(sum);
          details.appendChild(pre);
          turn.appendChild(details);
        }

        turn.scrollIntoView({ behavior: "smooth", block: "end" });
        return turn;
      }

      // ---- DOM refs ----
      const promptBox = document.getElementById("system-prompt");
      const chat = document.getElementById("chat");
      const form = document.getElementById("composer");
      const q = document.getElementById("q");
      const statusEl = document.getElementById("status");
      const bubbleTpl = document.getElementById("bubble");

      fetch("/LLM/system_prompt.txt")
        .then((response) => {
          if (!response.ok) {
            // íŒŒì¼ì´ ì—†ê±°ë‚˜ ì½ì„ ìˆ˜ ì—†ì„ ë•Œì˜ ì˜ˆì™¸ ì²˜ë¦¬
            throw new Error("Network response was not ok");
          }
          return response.text();
        })
        .then((text) => {
          promptBox.value = text;
        })
        .catch((error) => {
          console.error(
            "system_prompt.txt íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:",
            error
          );
          promptBox.placeholder = "system_prompt.txt íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        });
      // ---- socket.io ----
      //   const socket = io();

      // pending ì‘ë‹µ(ìƒê° ì¤‘â€¦) ë²„ë¸” ì°¸ì¡°
      let pendingBubble = null;

      // ---- UI helpers (ê¸°ì¡´ ìœ ì§€) ----
      function addBubble(text, who = "bot", html = false) {
        const node = bubbleTpl.content.firstElementChild.cloneNode(true);
        node.classList.add(who);
        const inner = node.querySelector(".bubble-inner");
        if (html) inner.innerHTML = text;
        else inner.textContent = text;
        chat.appendChild(node);
        node.scrollIntoView({ behavior: "smooth", block: "end" });
        return node;
      }

      // ì‹œê°„/ìš”ì¼ì— ë”°ë¼ ë™ì ì¸ ì¸ì‚¬ë§ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
      // function getDynamicGreeting() {
      //   const now = new Date();
      //   const hour = now.getHours(); // 0-23ì‹œ
      //   const day = now.getDay(); // 0:ì¼ìš”ì¼, 1:ì›”ìš”ì¼, ..., 6:í† ìš”ì¼

      //   // ì¸ì‚¬ë§ í›„ë³´ ëª©ë¡
      //   let possibleGreetings = [];

      //   // 1. ì‹œê°„ì— ë”°ë¥¸ ê¸°ë³¸ ì¸ì‚¬ë§ ì¶”ê°€
      //   if (hour >= 5 && hour < 12) {
      //     // ì˜¤ì „
      //     possibleGreetings.push(
      //       "ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤! ì˜¤ëŠ˜ ì½”ì—‘ìŠ¤ì—ì„œ ì–´ë–¤ ì¦ê±°ìš´ ì¼ì„ ê³„íší•˜ê³  ê³„ì‹ ê°€ìš”?",
      //       "í™œê¸°ì°¬ ì•„ì¹¨ì´ë„¤ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?",
      //       "ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”! ì €ëŠ” ì´ì†”ì´ë¼ê³  í•´ìš”. ì˜¤ëŠ˜ ì½”ì—‘ìŠ¤ì—” ë¬´ìŠ¨ ì¼ë¡œ ì˜¤ì…¨ë‚˜ìš”?"
      //     );
      //   } else if (hour >= 12 && hour < 18) {
      //     // ì˜¤í›„
      //     possibleGreetings.push(
      //       "í¸ì•ˆí•œ ì˜¤í›„ì…ë‹ˆë‹¤. ì½”ì—‘ìŠ¤ì—ì„œì˜ ì¦ê±°ìš´ ì‹œê°„ì„ ìœ„í•´ ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì„¸ìš”?",
      //       "ì ì‹¬ì€ ë§›ìˆê²Œ ë“œì…¨ë‚˜ìš”? ê¶ê¸ˆí•œ ì ì´ ìˆë‹¤ë©´ í¸í•˜ê²Œ ë¬¼ì–´ë³´ì„¸ìš”!",
      //       "ì¢‹ì€ ì˜¤í›„ì˜ˆìš”! ì½”ì—‘ìŠ¤ ì´ë²¤íŠ¸ ì•ˆë‚´ AI, ì´ì†”ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"
      //     );
      //   } else {
      //     // ì €ë… ë° ë°¤
      //     possibleGreetings.push(
      //       "ì–´ëŠë§ ì €ë…ì´ë„¤ìš”. ì € ì´ì†”ê³¼ í•¨ê»˜, ì˜¤ëŠ˜ í•˜ë£¨ì˜ ë§ˆë¬´ë¦¬ë¥¼ ì½”ì—‘ìŠ¤ì—ì„œ ì¦ê²¨ë³´ëŠ” ê±´ ì–´ë•Œìš”?",
      //       "ì €ë… ì‹œê°„ë„ ì½”ì—‘ìŠ¤ì™€ í•¨ê»˜! ì–´ë–¤ í–‰ì‚¬ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?",
      //       "ì•ˆë…•í•˜ì„¸ìš”! ì½”ì—‘ìŠ¤ ì´ë²¤íŠ¸ ì•ˆë‚´ AI, ì´ì†”ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?"
      //     );
      //   }

      //   // 2. ìš”ì¼ì— ë”°ë¥¸ íŠ¹ë³„ ì¸ì‚¬ë§ ì¶”ê°€
      //   if (day === 5) {
      //     // ê¸ˆìš”ì¼
      //     possibleGreetings.push(
      //       "ì‹ ë‚˜ëŠ” ê¸ˆìš”ì¼ì´ë„¤ìš”! ì£¼ë§ì— ì¦ê¸¸ ë§Œí•œ í–‰ì‚¬ë¥¼ ì°¾ì•„ë³´ì„¸ìš”."
      //     );
      //   } else if (day === 0 || day === 6) {
      //     // ì£¼ë§ (ì¼ìš”ì¼ ë˜ëŠ” í† ìš”ì¼)
      //     possibleGreetings.push(
      //       "ì¦ê±°ìš´ ì£¼ë§ì…ë‹ˆë‹¤! ì½”ì—‘ìŠ¤ì—ì„œ íŠ¹ë³„í•œ ì¶”ì–µì„ ë§Œë“¤ì–´ë³´ì„¸ìš”."
      //     );
      //   }

      //   // 3. í›„ë³´ ëª©ë¡ì—ì„œ ëœë¤ìœ¼ë¡œ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ë°˜í™˜
      //   const randomIndex = Math.floor(
      //     Math.random() * possibleGreetings.length
      //   );
      //   return possibleGreetings[randomIndex];
      // }

      // ---- socket events ----
      socket.on("connect", () => {
        statusEl.textContent = "ì—°ê²°ë¨";
        statusEl.classList.remove("bad");
        statusEl.classList.add("ok");
        console.log("[socket] connected:", socket.id);
      });

      socket.on("disconnect", () => {
        statusEl.textContent = "ì—°ê²° ëŠê¹€";
        statusEl.classList.remove("ok");
        statusEl.classList.add("bad");
        console.log("[socket] disconnected");
      });

      // ì„œë²„ì—ì„œ `reply` ì´ë²¤íŠ¸ë¡œ ë‚´ë ¤ì¤Œ
      // - ë¬¸ìì—´: ë°”ë¡œ ë´‡ ë§í’ì„ 
      // - ê°ì²´: { answer, hits } ë˜ëŠ” { error }
      socket.on("reply", (payload) => {
        if (pendingBubble) {
          pendingBubble.remove();
          pendingBubble = null;
        }

        if (typeof payload === "string") {
          addBubble(payload, "bot");
          return;
        }
        if (payload?.error) {
          addBubble("âš ï¸ " + payload.error, "bot");
          return;
        }

        // 1) ë§í’ì„  DOMì„ ë³€ìˆ˜ë¡œ ë°›ê¸°
        // const botNode = addBubble(payload?.answer || "(ì‘ë‹µ ì—†ìŒ)", "bot");

        // // 2) ê·¸ ë§í’ì„  "ë°”ë¡œ ì•„ë˜"ì— í† í° ë¼ì¸ ì‚½ì…
        // if (payload?.tokens) {
        //   addTokenLine(botNode, payload.tokens);
        // }

        addBotTurn(payload?.answer, payload?.tokens, payload?.hits);

        // addBubble(payload?.answer || "(ì‘ë‹µ ì—†ìŒ)", "bot");
        // if (payload?.hits) addHits(payload.hits);

        // // âœ… í† í° ì •ë³´ í‘œì‹œ
        // if (payload?.tokens) {
        //   const { input, output, total } = payload.tokens;
        //   const tokenInfoEl = document.getElementById("token-info");
        //   tokenInfoEl.textContent = `ğŸ“Š í† í° ì‚¬ìš©ëŸ‰: ì…ë ¥ ${input}, ì¶œë ¥ ${output}, ì´ ${total}`;
        // }
      });

      // ---- form submit â†’ socket.emit ----
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = q.value.trim();
        if (!text) return;

        // ë‚˜(ì‚¬ìš©ì) ë§í’ì„ 
        addBubble(text, "you");
        q.value = "";

        // ìƒê° ì¤‘â€¦
        pendingBubble = addBubble("ìƒê° ì¤‘â€¦", "bot");
        pendingBubble.classList.add("thinking");

        // ì„œë²„ë¡œ ì§ˆë¬¸ ì „ì†¡ (systemPrompt í¬í•¨)
        socket.emit("message", {
          question: text,
          systemPrompt: promptBox.value,
        });
      });

      // ëª¨ë°”ì¼/ì—”í„° ì „ì†¡
      q.addEventListener("keydown", (e) => {
        // IME(ì…ë ¥ê¸°)ê°€ ê¸€ìë¥¼ ì¡°í•©í•˜ëŠ” ì¤‘ì—ëŠ” Enter í‚¤ë¡œ ì¸í•œ ì œì¶œì„ ë°©ì§€í•©ë‹ˆë‹¤.
        if (e.isComposing) {
          return;
        }
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          form.requestSubmit();
        }
      });
      // ---- 'go' button event ----
      const goBtn = document.getElementById("go-btn");

      goBtn.addEventListener("click", () => {
        // ë²„íŠ¼ê³¼ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì…ë ¥ì°½ ë¹„í™œì„±í™”
        goBtn.disabled = true;
        promptBox.disabled = true;

        // "ìƒê° ì¤‘..." ë²„ë¸” í‘œì‹œ
        pendingBubble = addBubble("ìƒê° ì¤‘â€¦", "bot");
        pendingBubble.classList.add("thinking");

        // ì„œë²„ë¡œ ëŒ€í™” ì‹œì‘ ì´ë²¤íŠ¸ ì „ì†¡
        socket.emit("start-conversation", {
          systemPrompt: promptBox.value,
        });
      });

      // ê¸°ì¡´ ì½”ë“œ ìœ ì§€
      q.focus();

      // [ìˆ˜ì •] ì‹œì‘ ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ë™ì ìœ¼ë¡œ ìƒì„±ëœ ì¸ì‚¬ë§ë¡œ êµì²´
      // addBubble(getDynamicGreeting(), "bot");
      q.focus();
    </script>
  </body>
</html>
