<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"
    />
    <title>COEX RAG Assistant</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="title">COEX ì´ë²¤íŠ¸ ì•ˆë‚´</div>
      <div id="status" class="status">ì—°ê²° í™•ì¸ ì¤‘â€¦</div>
    </header>
    <div id="token-info" class="token-info"></div>

    <main id="chat" class="chat"></main>

    <form id="composer" class="composer" autocomplete="off">
      <input
        id="q"
        class="input"
        type="text"
        inputmode="search"
        placeholder="ì˜ˆ) ì´ë²ˆ ì£¼ë§ ê°€ì¡± ì²´í—˜ í”„ë¡œê·¸ë¨ ì¶”ì²œí•´ì¤˜"
      />
      <button class="send" aria-label="ë³´ë‚´ê¸°">ë³´ë‚´ê¸°</button>
    </form>

    <template id="bubble">
      <div class="bubble">
        <div class="bubble-inner"></div>
      </div>
    </template>

    <!-- <script src="/socket.io/socket.io.js"></script> -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      // ê¸°ë³¸ ë°±ì—”ë“œ URL (Render/Railway ê°™ì€ ê³ ì • ì£¼ì†Œê°€ ìˆìœ¼ë©´ ì—¬ê¸° ë„£ê¸°)
      const DEFAULT_API = "https://9e39b3c778de.ngrok-free.app"; // ì„ì‹œ: ngrok ì£¼ì†Œ or ê³ ì • ë°±ì—”ë“œ ì£¼ì†Œ

      // í¸ì˜ê¸°ëŠ¥: ?api= ë¡œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥ + localStorage ì €ì¥
      const urlApi = new URLSearchParams(location.search).get("api");
      const lsApi = localStorage.getItem("API_BASE");
      const API = urlApi || lsApi || DEFAULT_API;
      if (urlApi) localStorage.setItem("API_BASE", urlApi);

      console.log("[client] API =", API);

      // WebSocket ì—°ê²°
      const socket = io(API, {
        path: "/socket.io",
        transports: ["websocket"],
      });

      socket.on("connect", () => {
        const statusEl = document.getElementById("status");
        statusEl.textContent = "ì—°ê²°ë¨";
        statusEl.classList.remove("bad");
        statusEl.classList.add("ok");
        console.log("[socket] connected:", socket.id);
      });
      socket.on("disconnect", () => {
        const statusEl = document.getElementById("status");
        statusEl.textContent = "ì—°ê²° ëŠê¹€";
        statusEl.classList.remove("ok");
        statusEl.classList.add("bad");
        console.log("[socket] disconnected");
      });

      // (ì„ íƒ) í—¬ìŠ¤ì²´í¬ ë¡œê·¸ë¡œ ë°±ì—”ë“œ í†µì‹  í™•ì¸
      fetch(`${API}/health`)
        .then((r) => r.json())
        .then((j) => console.log("[health]", j))
        .catch((err) => console.warn("[health error]", err));
      // ë§Œì•½ fetchë¥¼ ì“°ëŠ” ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì´ë ‡ê²Œ:
      // fetch(`${API}/health`)
      // fetch(`${API}/query_with_embedding`, { ... })
    </script>

    <script>
      // ---- DOM refs ----
      const chat = document.getElementById("chat");
      const form = document.getElementById("composer");
      const q = document.getElementById("q");
      const statusEl = document.getElementById("status");
      const bubbleTpl = document.getElementById("bubble");

      // ---- socket.io ----
      //   const socket = io();

      // pending ì‘ë‹µ(ìƒê° ì¤‘â€¦) ë²„ë¸” ì°¸ì¡°
      let pendingBubble = null;

      // ---- UI helpers (ê¸°ì¡´ ìœ ì§€) ----
      function addBubble(text, who = "bot", html = false) {
        const node = bubbleTpl.content.firstElementChild.cloneNode(true);
        node.classList.add(who);
        const inner = node.querySelector(".bubble-inner");
        if (html) inner.innerHTML = text;
        else inner.textContent = text;
        chat.appendChild(node);
        node.scrollIntoView({ behavior: "smooth", block: "end" });
        return node;
      }

      function addHits(hits) {
        if (!hits || !hits.length) return;
        const lines = hits.map(
          (h, i) =>
            `[${i + 1}] ${h?.meta?.title || ""} | ${h?.meta?.date || ""} | ${
              h?.meta?.venue || ""
            }`
        );
        const details = document.createElement("details");
        details.className = "hits";
        const sum = document.createElement("summary");
        sum.textContent = `ì°¸ì¡°í•œ ì´ë²¤íŠ¸ (${hits.length})`;
        details.appendChild(sum);
        const pre = document.createElement("pre");
        pre.textContent = lines.join("\n");
        details.appendChild(pre);
        chat.appendChild(details);
        details.scrollIntoView({ behavior: "smooth", block: "end" });
      }

      // ---- socket events ----
      socket.on("connect", () => {
        statusEl.textContent = "ì—°ê²°ë¨";
        statusEl.classList.remove("bad");
        statusEl.classList.add("ok");
        console.log("[socket] connected:", socket.id);
      });

      socket.on("disconnect", () => {
        statusEl.textContent = "ì—°ê²° ëŠê¹€";
        statusEl.classList.remove("ok");
        statusEl.classList.add("bad");
        console.log("[socket] disconnected");
      });

      // ì„œë²„ì—ì„œ `reply` ì´ë²¤íŠ¸ë¡œ ë‚´ë ¤ì¤Œ
      // - ë¬¸ìì—´: ë°”ë¡œ ë´‡ ë§í’ì„ 
      // - ê°ì²´: { answer, hits } ë˜ëŠ” { error }
      socket.on("reply", (payload) => {
        if (pendingBubble) {
          pendingBubble.remove();
          pendingBubble = null;
        }

        if (typeof payload === "string") {
          addBubble(payload, "bot");
          return;
        }
        if (payload?.error) {
          addBubble("âš ï¸ " + payload.error, "bot");
          return;
        }
        addBubble(payload?.answer || "(ì‘ë‹µ ì—†ìŒ)", "bot");
        if (payload?.hits) addHits(payload.hits);

        // âœ… í† í° ì •ë³´ í‘œì‹œ
        if (payload?.tokens) {
          const { input, output, total } = payload.tokens;
          const tokenInfoEl = document.getElementById("token-info");
          tokenInfoEl.textContent = `ğŸ“Š í† í° ì‚¬ìš©ëŸ‰: ì…ë ¥ ${input}, ì¶œë ¥ ${output}, ì´ ${total}`;
        }
      });

      // ---- form submit â†’ socket.emit ----
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = q.value.trim();
        if (!text) return;

        // ë‚˜(ì‚¬ìš©ì) ë§í’ì„ 
        addBubble(text, "you");
        q.value = "";

        // ìƒê° ì¤‘â€¦
        pendingBubble = addBubble("ìƒê° ì¤‘â€¦", "bot");
        pendingBubble.classList.add("thinking");

        // ì„œë²„ë¡œ ì§ˆë¬¸ ì „ì†¡ (WS)
        socket.emit("message", text);
      });

      // ëª¨ë°”ì¼/ì—”í„° ì „ì†¡
      q.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          form.requestSubmit();
        }
      });

      // ì‹œì‘ ì•ˆë‚´
      addBubble(
        "ì•ˆë…•í•˜ì„¸ìš”! ì›í•˜ëŠ” ì „ì‹œë‚˜ í”„ë¡œê·¸ë¨ì„ ë¬¼ì–´ë³´ì„¸ìš”.\nì˜ˆ) 9ì›” ì£¼ë§ ê°€ì¡± ì²´í—˜ / ë¹„ê±´ í˜ìŠ¤í‹°ë²Œ / ì´ˆë“±í•™ìƒ ëŒ€ìƒ í–‰ì‚¬",
        "bot"
      );
      q.focus();
    </script>
  </body>
</html>
